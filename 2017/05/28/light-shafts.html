<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Isaac Hayes Wallpaper Generator - Volumetric light scattering, 1 of 2</title>
  <meta name="description" content="  This post is greatly based on the Nvidia GPU Gem on volumetric light scattering. Here I walk you through the formulae and core concepts. I highly recommend...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/2017/05/28/light-shafts.html">
  <link rel="alternate" type="application/rss+xml" title="Chuck LePlant" href="http://localhost:4000/feed.xml">
  <link rel="stylesheet" type="text/css" href="http://localhost:4000/css/jekyll-photo-gallery.css">
  <link rel="stylesheet" href="http://localhost:4000/css/justifiedGallery.min.css">

  <script type="text/javascript" async
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
    MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } }});
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Chuck LePlant</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
          <a class="page-link" href="/about">About</a>
          <a class="page-link" href="/photography">Gallery</a>
          <a class="page-link" href="/archive">Archive</a>
      
      </div>
    </nav>

    

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Isaac Hayes Wallpaper Generator - Volumetric light scattering, 1 of 2</h1>
    <p class="post-meta"><time datetime="2017-05-28T00:00:00+02:00" itemprop="datePublished">May 28, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <blockquote>
  <p>This post is greatly based on the <a href="https://developer.nvidia.com/gpugems/GPUGems3/gpugems3_ch13.html">Nvidia GPU Gem on volumetric light scattering</a>. Here I walk you through the formulae and core concepts. I highly recommend reading that one instead, and come back only if you couldn’t follow, or for fun.</p>

  <p>If you’re unfamiliar with computer graphics, I highly recommend you to watch <a href="https://youtu.be/IyUgHPs86XM">John Carmack’s talk on lighting and rendering</a>.</p>
</blockquote>

<div class="Container">
    <div class="Content">
<img src="/images/red-dead-shaft.png" alt="Light shafts sample image, generated with the *Isaac Hayes Wallpaper Generator* tool, available in the second part of this entry. The image is from Rockstar's Red Dead Redemption 2 concept art." />  
    </div>
</div>
<p><span class="caption" style="font-size: 80%"><i>Light shafts sample image, generated with the <em>Isaac Hayes Wallpaper Generator</em> tool, available in the second part of this entry. The image is from Rockstar’s Red Dead Redemption 2 concept art.</i></span></p>

<p>Often there’s one rendering effect that has me in awe everytime I see it. The first one I remember was normal mapping. While playing videogames I used to walk towards a wall that had a light bulb nearby, and then I spent a good 10 minutes just moving near the wall, seeing how the light behaved.</p>

<p>Lately I found myself doing the same thing while playing The Witcher 3, I just forwarded time until the sun was low enough so I could just toy with the light shaft effects between the trees. And then again, I spend a shameful amount of time just walking back and forth seeing how these patterns would unfold.</p>

<p>For the sake of me actually playing videogames instead of just being mesmerized by technical feats, I decided to understand how light shafts are generated and what’s the theory behind it.</p>

<p>My hope here is to give any reader a shallow but thorough overview of computer graphics rendering and physically based rendering effects. These two concepts are rather tangent, in the sense that computer graphics will not use the actual physical formulae, but hacky approximations.</p>

<h2 id="rendering-equation-review">Rendering equation review</h2>

<p><img src="/images/rendering-equation-drawing.png" alt="renderineq" /></p>

<script type="math/tex; mode=display">\definecolor{steadyblue}{RGB}{0,76,212} %004CD4
\definecolor{lobster}{RGB}{185,138,162} %B98AA2
\definecolor{mars}{RGB}{255,165,44} %FFA52C
\definecolor{rosamund}{RGB}{198,73,255} %C649FF
\definecolor{gold}{RGB}{255,206,63} %FFCE3F
\definecolor{bleu}{RGB}{73,214,255} %49D6FF
\definecolor{pistacho}{RGB}{118,163,39} %76A327
\definecolor{sea}{RGB}{41,153,124}  %29997C 
\definecolor{flower}{RGB}{255,85,149} %FF5595

\color{steadyblue}{L_{\text{o}}(\mathbf x,\, \omega_{\text{o}})} \color{black}{\,=\,} \color{mars}{L_e(\mathbf x,\, \omega_{\text{o}})} \color{black}{\ +\,} \color{bleu}{\int_\Omega} \color{flower}{f_r(\mathbf x,\, \omega_{\text{i}},\, \omega_{\text{o}})\,} \color{rosamund}{L_{\text{i}}(\mathbf x,\, \omega_{\text{i}})\,} \color{pistacho}{(\omega_{\text{i}}\,\cdot\,\mathbf n)\,} \color{bleu}{\operatorname d \omega_{\text{i}}}</script>

<p>To find <font color="#004CD4">the light towards the viewer from a specific point</font>, we sum the <font color="#FFA52C">light emitted from such point</font> plus <font color="#49D6FF">the integral within the unit hemisphere</font> of <font color="#C649FF">the light coming from a any given direction</font> multiplied by the <font color="#FF5595">chances of such light rays bouncing towards the viewer</font><sup id="fnref:100"><a href="#fn:100" class="footnote">1</a></sup> and also by <font color="#76A327">the irradiance factor over the normal at the point</font>.<sup id="fnref:1"><a href="#fn:1" class="footnote">2</a></sup><script type="math/tex">^,</script><sup id="fnref:2"><a href="#fn:2" class="footnote">3</a></sup></p>

<p>Note that <font color="C649FF">incoming light</font> is also computed by that very formula, which makes this exhaustingly recursive.</p>

<p>So, think about the pixel you’re reading right now, your screen is probably emitting more light than it transmits from other sources, if you have a glossy screen, then you see your own reflection. Meaning that for every point in your screen, light is reflected along the surface normal (perpendicular to your screen) in a <strong>specular</strong> fashion.</p>

<p>If you have a non-glossy screen, then the light bouncing from other light sources is more evenly distributed over the reflection hemisphere, hence not forming a clear image as a result, but a <strong>diffuse</strong> image instead.</p>

<h2 id="volumetric-light-scattering-equations">Volumetric light scattering equations</h2>

<p>Light, as the electromagnetic radiation it is, interacts with matter mainly in two ways<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup>:</p>

<ul>
  <li>Absorption (The photons disappear)</li>
  <li>Scattering (The photons change their direction)</li>
</ul>

<p>In both cases the <strong>transmitted intensity</strong> <script type="math/tex">I</script> decreases exponentially. Being <script type="math/tex">\tau</script> the extinction coefficient composed of light absortion and out-scattering, and <script type="math/tex">s</script> the thickness of the medium we traverse, we use an exponential function over <script type="math/tex">e</script> to represent the extinction coefficient<sup id="fnref:3"><a href="#fn:3" class="footnote">5</a></sup>:</p>

<script type="math/tex; mode=display">I=I_\text{o} · e^{-\tau s}</script>

<p>This helps us understand how scattering is first modelled in Nvidia’s GPU gem on volumetric light scattering<sup id="fnref:7"><a href="#fn:7" class="footnote">6</a></sup>. Let <script type="math/tex">s</script> be the distance through the media and <script type="math/tex">\theta</script> the angle between the viewer and the light beam:</p>

<p><img src="/images/rendering-scatter-terms.png" alt="scattering-terms" /></p>

<script type="math/tex; mode=display">\definecolor{steadyblue}{RGB}{0,76,212} %004CD4
\definecolor{lobster}{RGB}{185,138,162} %B98AA2
\definecolor{mars}{RGB}{255,165,44} %FFA52C
\definecolor{rosamund}{RGB}{198,73,255} %C649FF
\definecolor{gold}{RGB}{255,206,63} %FFCE3F
\definecolor{bleu}{RGB}{73,214,255} %49D6FF
\definecolor{pistacho}{RGB}{118,163,39} %76A327
\definecolor{sea}{RGB}{41,153,124}  %29997C 
\definecolor{greenbean}{RGB}{76,153,0}  %4C9900 

\color{red}{L(s,\,\theta)} \color{black}{\,=\,} \color{steadyblue}{L_\text{o}} \color{rosamund}{\,e^{-\tau s}} \color{black}{\,+\,} \frac{1}{\tau} \color{orange}{\,E_{sun}} \color{greenbean}{\,S(\theta)} \color{black}{\,(1 \,-\, } \color{rosamund}{e^{-\tau s}}\color{black}{)}</script>

<p>The <font color="FF0000">light accounting for volumetric scattering</font> is a linear interpolation <font color="C649FF">weighed by the extinction constant</font>. Note how we interpolate between the <font color="004CD4">light computed at a given point</font> and the light due to scattering, which is a product of the <font color="FFAF00">source illumination</font> from the sun (or light source) and the <font color="4C9900">angular scattering term</font> according to Rayleigh and Mie properties.</p>

<p>Let’s talk a bit about the <font color="4C9900">Rayleigh and Mie term</font>, it’s a function of particle size, shape and composition of the medium we traverse. This component and the extinction coefficient model the atmosphere or space through which light scatters.</p>

<p>In a nutshell, smaller particles scatter according to the Rayleigh model, and larger particles according to Mie. In this context we consider smaller particles the ones much smaller than the wavelength of incoming light.</p>

<p>This means Rayleigh scattering bounces off smaller wavelengths, such as the blue spectrum. Mie on the other hand, is not dependent on wavelength, and it scatters the whole spectrum of light. Clouds are white because sunlight is white.</p>

<div class="Container">
    <div class="Content">
<img src="/images/rayleigh-meow.png" alt="Rayleigh and Mie scattering describes how light scatters off of molecules in a medium depending on the size of those molecules. Smaller molecules respond to Mie scattering more than Rayleigh and viceversa.[^44]" />  
    </div>
</div>
<p><span class="caption" style="font-size: 80%"><i>Rayleigh and Mie scattering describes how light scatters off of molecules in a medium depending on the size of those molecules. Smaller molecules respond to Mie scattering more than Rayleigh and viceversa.<sup id="fnref:44"><a href="#fn:44" class="footnote">7</a></sup></i></span></p>

<h2 id="occlusion">Occlusion</h2>

<p>Last but not least, we need to take occluders into the equation. Let <script type="math/tex">\phi</script> represent the ray from the light emitter towards the observed point:</p>

<script type="math/tex; mode=display">L(s,\,\theta,\,\phi) = (1 \,-\, \color{orange}{D(\phi)}\color{black}{)} \color{red}{\,L(s,\,\theta)}</script>

<p>Is the light accounting for both <font color="FF0000">volumetric light scattering</font> and <font color="FFA600">the opacity term of all occluders</font>, which is the total opacity of the ocluders along the ray.</p>

<p>This term accumulates objects’ opacity. If there’s a solid object between light source and observer all light energy will be zeroed, however we must account for indirect light as well as seen in eq. 1.</p>

<h2 id="wrap-up">Wrap up</h2>

<p>This covers a shallow walk through the theory of visible light and atmospheric scattering. With the information above we should be able to compute the light <em>energy</em> towards the viewer for any point in space, note that we left out things like light wavelength for simplicity. I hope you have enough to get started.</p>

<p>In the next entry I will demonstrate these concepts implementing volumetric shafts of light with GLSL, completely dismissing all we learnt here and just hacking our way to rendered images.</p>

<p><a href="/2017/12/04/light-shafts-pt-2.html">Continue to part 2</a></p>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:100">
      <p><a href="https://en.wikipedia.org/wiki/Bidirectional_reflectance_distribution_function">Bidirectional reflectance distribution function</a> <a href="#fnref:100" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:1">
      <p><a href="https://en.wikipedia.org/wiki/Rendering_equation">Rendering equation</a> <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p><a href="http://adereth.github.io/blog/2013/11/29/colorful-equations/">Colorful equations with MathJax</a> <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p><a href="http://www.nbi.dk/~ogendal/personal/lho/lightscattering_theory_and_practice.pdf">Light Scattering Demystified - Theory and Practice, Lars Øgendal</a> <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p><a href="https://www.youtube.com/watch?v=AuA2EAgAegE">Why number <script type="math/tex">e</script>?</a> <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:7">
      <p><a href="https://developer.nvidia.com/gpugems/GPUGems3/gpugems3_ch13.html">Nvidia GPU Gems, Chapter 13. Volumetric Light Scattering as a Post-Process</a> <a href="#fnref:7" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:44">
      <p>Image based on <a href="http://hyperphysics.phy-astr.gsu.edu/hbase/atmos/blusky.html">Hyperphysics scattering post</a> and derived from <a href="https://commons.wikimedia.org/wiki/File:Mie_scattering.svg">Sharayanan’s work</a>. Under the <a href="https://creativecommons.org/licenses/by-sa/3.0/deed.en">Creative Commons Attribution-Share Alike 3.0 Unported</a> licence. <a href="#fnref:44" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>
   
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.developer = 1;
this.page.url = 'http://localhost:4000/2017/05/28/light-shafts.html';  
this.page.identifier = 'McShafty'; 
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://chuckleplant.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Chuck LePlant</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Chuck LePlant</li>
          <li><a href="mailto:sergio.basurco@gmail.com">sergio.basurco@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/chuckleplant"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">chuckleplant</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Sergio Basurco's personal portfolio. I'm a software developer based in Barcelona. Have fun browsing my little projects.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

  <script src="http://localhost:4000/js/vendor/jquery-1.9.1.min.js"></script>
  <script src="http://localhost:4000/js/plugins/jquery.justifiedGallery.min.js"></script>
</html>
